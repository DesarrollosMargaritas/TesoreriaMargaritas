@page "/tesorero"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using TesoreriaMargaritas.Services
@attribute [Authorize(Roles = "Tesorero, Administrador")]
@rendermode RenderMode.InteractiveServer
@inject TesoreriaService TesoreriaService
@inject NavigationManager NavigationManager

<PageTitle>Panel de Tesorería</PageTitle>

<div class="container mt-5">

    <!-- ALERTA DE BLOQUEO POR CIERRE PENDIENTE -->
    @if (hayCierrePendiente)
    {
        <div class="alert alert-warning border-warning shadow-sm mb-4" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> ¡Atención! Cierre Pendiente</h4>
            <p>
                El sistema ha detectado movimientos de días anteriores que aún no han sido cerrados.
                Por reglas de negocio, <strong>debe realizar el cierre de caja</strong> antes de continuar operando con normalidad.
            </p>
            <hr>
            <div class="d-flex justify-content-end">
                <a href="/operaciones/cierre-caja" class="btn btn-warning fw-bold">
                    <i class="bi bi-safe2-fill"></i> Ir al Cierre de Caja Ahora
                </a>
            </div>
        </div>
    }

    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-primary border-bottom pb-2">
                <i class="bi bi-speedometer2"></i> Tablero de Control - Tesorería
            </h2>
            <p class="text-muted">Bienvenido. Aquí tiene un resumen de la actividad de hoy.</p>
        </div>
    </div>

    <!-- Sección de Resumen Rápido (KPIs) -->
    <div class="row mb-5">
        <!-- Tarjeta Ingresos -->
        <div class="col-md-4">
            <div class="card bg-success text-white shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <h5 class="card-title"><i class="bi bi-cash-coin"></i> Ingresos de Hoy</h5>
                        <p class="card-text opacity-75">Total recaudado en el día</p>
                    </div>
                    <div class="mt-3 text-end">
                        @if (cargando)
                        {
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        }
                        else
                        {
                            <h2 class="display-6 fw-bold">@totalEntradasHoy.ToString("C0")</h2>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta Salidas -->
        <div class="col-md-4">
            <div class="card bg-danger text-white shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <h5 class="card-title"><i class="bi bi-cart-x"></i> Salidas de Hoy</h5>
                        <p class="card-text opacity-75">Total pagado en el día</p>
                    </div>
                    <div class="mt-3 text-end">
                        @if (cargando)
                        {
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        }
                        else
                        {
                            <h2 class="display-6 fw-bold">@totalSalidasHoy.ToString("C0")</h2>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta Balance -->
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <h5 class="card-title"><i class="bi bi-wallet2"></i> Balance Actual</h5>
                        <p class="card-text opacity-75">Efectivo disponible hoy</p>
                    </div>
                    <div class="mt-3 text-end">
                        @if (cargando)
                        {
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        }
                        else
                        {
                            <h2 class="display-6 fw-bold">@balanceHoy.ToString("C0")</h2>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Menú de Operaciones -->
    <div class="row">
        <div class="col-12 mb-3">
            <h4 class="text-secondary">Operaciones Disponibles</h4>
        </div>

        <div class="col-md-4 mb-4">
            <a href="@(hayCierrePendiente ? "#" : "/operaciones/entradas")" class="text-decoration-none @(hayCierrePendiente ? "disabled-link" : "")">
                <div class="card h-100 border-success shadow-sm hover-effect @(hayCierrePendiente ? "opacity-50" : "")">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-plus-circle-fill text-success display-4 mb-3"></i>
                        <h4 class="text-dark">Entradas</h4>
                        <p class="text-muted small">Ingresos y Aportes</p>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-4 mb-4">
            <a href="@(hayCierrePendiente ? "#" : "/operaciones/salidas")" class="text-decoration-none @(hayCierrePendiente ? "disabled-link" : "")">
                <div class="card h-100 border-danger shadow-sm hover-effect @(hayCierrePendiente ? "opacity-50" : "")">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-dash-circle-fill text-danger display-4 mb-3"></i>
                        <h4 class="text-dark">Salidas</h4>
                        <p class="text-muted small">Gastos y Pagos</p>
                    </div>
                </div>
            </a>
        </div>

        <!-- NUEVO BOTÓN CIERRE -->
        <div class="col-md-4 mb-4">
            <a href="/operaciones/cierre-caja" class="text-decoration-none">
                <div class="card h-100 border-primary shadow-sm hover-effect bg-primary text-white">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-safe2-fill text-white display-4 mb-3"></i>
                        <h4 class="text-white">Cierre de Caja</h4>
                        <p class="text-white-50 small">Arqueo y Cierre del Día</p>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>

<style>
    .hover-effect:hover {
        transform: translateY(-5px);
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
    }

    .disabled-link {
        pointer-events: none;
        cursor: not-allowed;
    }
</style>

@code {
    private decimal totalEntradasHoy = 0;
    private decimal totalSalidasHoy = 0;
    private decimal balanceHoy => totalEntradasHoy - totalSalidasHoy;
    private bool cargando = true;
    private bool hayCierrePendiente = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. Verificamos Bloqueo
            hayCierrePendiente = await TesoreriaService.HayMovimientosPendientesDiasAnterioresAsync();

            // 2. Cargamos KPIs
            totalEntradasHoy = await TesoreriaService.ObtenerTotalEntradasHoyAsync();
            totalSalidasHoy = await TesoreriaService.ObtenerTotalGastosHoyAsync();
        }
        finally
        {
            cargando = false;
        }
    }
}